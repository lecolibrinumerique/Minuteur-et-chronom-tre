<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Minuteur & Chronomètre — Version simple</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel pour JSX (sans TypeScript) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg);} }
      @keyframes spin-rev { from { transform: rotate(360deg); } to { transform: rotate(0deg);} }
      @keyframes aura { 0%{ box-shadow: 0 0 0 0 rgba(250,204,21,0.15); } 70%{ box-shadow: 0 0 40px 10px rgba(250,204,21,0.18);} 100%{ box-shadow: 0 0 0 0 rgba(250,204,21,0);} }
      @keyframes sand { 0%{ opacity:.7 } 50%{ opacity:1 } 100%{ opacity:.7 } }
      @keyframes warning { 0%{ box-shadow: 0 0 0 0 rgba(251,191,36,0.0);} 50%{ box-shadow: 0 0 40px 10px rgba(251,191,36,0.25);} 100%{ box-shadow: 0 0 0 0 rgba(251,191,36,0.0);} }
      .animate-spin-slow { animation: spin-slow 9s linear infinite; }
      .animate-spin-rev { animation: spin-rev 12s linear infinite; }
      .animate-aura { animation: aura 2.4s ease-in-out infinite; }
      .animate-sand { animation: sand 1s ease-in-out infinite; }
      .animate-warning { animation: warning 1.2s ease-in-out infinite; }
    </style>
  </head>
  <body class="bg-black">
    <div id="app"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect, useRef } = React;

      const MODES = { CHRONO: "chronometre", TIMER: "minuteur" };

      function MinuteurChronometre() {
        const [mode, setMode] = useState(MODES.CHRONO);
        const [running, setRunning] = useState(false);
        const [elapsed, setElapsed] = useState(0);

        const [h, setH] = useState(0);
        const [m, setM] = useState(0);
        const [s, setS] = useState(0);
        const totalSeconds = useMemo(() => h * 3600 + m * 60 + s, [h, m, s]);
        const [remaining, setRemaining] = useState(0);
        const [initialDuration, setInitialDuration] = useState(0);

        // ✅ Mode “affichage élève”
        const [studentView, setStudentView] = useState(false);

        const intervalRef = useRef(null);

        function start() {
          if (running) return;
          if (mode === MODES.TIMER) {
            const init = remaining > 0 ? remaining : totalSeconds;
            if (init <= 0) return;
            setRemaining(init);
            setInitialDuration(init);
          }
          setRunning(true);
        }

        function stop() { setRunning(false); }

        function reset() {
          setRunning(false);
          setElapsed(0);
          setRemaining(0);
          setInitialDuration(0);
        }

        useEffect(() => {
          if (!running) {
            if (intervalRef.current) {
              clearInterval(intervalRef.current);
              intervalRef.current = null;
            }
            return;
          }
          intervalRef.current = setInterval(() => {
            if (mode === MODES.CHRONO) {
              setElapsed(e => e + 1);
            } else {
              setRemaining(r => {
                const next = r - 1;
                if (next <= 0) {
                  try { playBeep(); } catch(e) {}
                  setRunning(false);
                  return 0;
                }
                return next;
              });
            }
          }, 1000);

          return () => {
            if (intervalRef.current) {
              clearInterval(intervalRef.current);
              intervalRef.current = null;
            }
          };
        }, [running, mode]);

        useEffect(() => {
          if (!running && mode === MODES.TIMER) setRemaining(totalSeconds);
        }, [totalSeconds, running, mode]);

        // ✅ Raccourci clavier: touche "E" pour basculer affichage élève
        useEffect(() => {
          const onKeyDown = (e) => {
            if (e.key && e.key.toLowerCase() === "e") {
              setStudentView(v => !v);
            }
          };
          window.addEventListener("keydown", onKeyDown);
          return () => window.removeEventListener("keydown", onKeyDown);
        }, []);

        function playBeep() {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          if (!Ctx) return;
          const ctx = new Ctx();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine"; o.frequency.value = 880;
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.35, ctx.currentTime + 0.01);
          o.start();
          g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.8);
          o.stop(ctx.currentTime + 0.85);
        }

        function format(sec) {
          const t = Math.max(0, Math.abs(sec));
          const hh = Math.floor(t / 3600);
          const mm = Math.floor((t % 3600) / 60);
          const ss = Math.floor(t % 60);
          const pad = (n) => String(n).padStart(2, "0");
          return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
        }

        const displayTime = mode === MODES.CHRONO ? elapsed : remaining;
        const timerProgress = mode === MODES.TIMER && initialDuration > 0
          ? Math.min(1, Math.max(0, 1 - remaining / initialDuration))
          : 0;
        const lastSeconds = mode === MODES.TIMER && remaining > 0 && remaining <= 10;

        const containerGlow = running
          ? "shadow-[0_0_40px_rgba(251,191,36,0.15)] ring-2 ring-amber-300/50"
          : "ring-1 ring-zinc-600/60";

        // ✅ En mode élève, on agrandit la “carte” et on centre plus fort
        const shell = studentView
          ? "w-full max-w-5xl"
          : "w-full max-w-4xl";

        return (
          <div className="min-h-screen w-full relative overflow-hidden bg-gradient-to-b from-[#0b0d12] via-[#0b0d12] to-[#151827] text-zinc-100 flex items-center justify-center p-6">
            <div className={shell + " relative"}>

              {/* ✅ En-tête : en mode élève on peut garder juste les toggles (ou même les masquer si tu veux) */}
              <div className={`mb-4 flex items-center justify-between ${studentView ? "opacity-90" : ""}`}>
                <h1 className="text-2xl font-semibold tracking-tight flex items-center gap-2">
                  {mode === MODES.CHRONO ? "Retourneur de Temps" : "Sablier Magique"}
                  {!studentView && (
                    <span className="text-xs text-zinc-400">— Minuteur & Chronomètre</span>
                  )}
                </h1>

                <div className="flex items-center gap-2">
                  <StudentViewToggle value={studentView} onChange={setStudentView} />
                  <ModeSwitcher mode={mode} onChange={(m)=>{ setMode(m); reset(); }} />
                </div>
              </div>

              <div className={`bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur ${containerGlow}`}>
                <div className={`grid grid-cols-1 md:grid-cols-[1fr_auto] gap-8 md:items-center ${studentView ? "md:gap-12" : ""}`}>
                  <div className="flex flex-col">
                    <TimeDisplay value={displayTime} format={format} running={running} studentView={studentView} />

                    {/* ✅ Controls cachés en affichage élève */}
                    {!studentView && (
                      <>
                        <div className="mt-4 flex gap-3 flex-wrap">
                          {!running ? (
                            <button onClick={start} className="px-5 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 active:scale-[.99] transition font-medium">Démarrer</button>
                          ) : (
                            <button onClick={stop} className="px-5 py-3 rounded-xl bg-amber-600 hover:bg-amber-500 active:scale-[.99] transition font-medium">Arrêter</button>
                          )}
                          <button onClick={reset} className="px-5 py-3 rounded-xl bg-zinc-700 hover:bg-zinc-600 active:scale-[.99] transition font-medium">Remettre à zéro</button>
                          {mode === MODES.TIMER && (
                            <button onClick={playBeep} className="px-5 py-3 rounded-xl bg-sky-700 hover:bg-sky-600 active:scale-[.99] transition font-medium">Tester l'alarme</button>
                          )}
                        </div>

                        {mode === MODES.TIMER && (
                          <p className="mt-4 text-sm text-zinc-400">
                            {initialDuration === 0 ? "Définissez une durée puis pressez « Démarrer »." :
                              running ? "Compte à rebours en cours." :
                              remaining > 0 ? `Prêt: ${format(remaining)}` : "Prêt à démarrer."}
                          </p>
                        )}
                      </>
                    )}
                  </div>

                  <div className="place-self-center md:justify-self-center">
                    {mode === MODES.CHRONO ? (
                      <TimeTurnerVisual running={running} />
                    ) : (
                      <HourglassVisual running={running} progress={timerProgress} warn={!!lastSeconds} />
                    )}
                  </div>
                </div>

                {/* ✅ Zone minuteur : cachée en mode élève */}
                {!studentView && mode === MODES.TIMER ? (
                  <div className="mt-8">
                    <TimerInputs h={h} m={m} s={s}
                      onH={setH} onM={setM} onS={setS} disabled={running} />
                    <PresetRow onPick={(sec)=>{
                      const H=Math.floor(sec/3600), M=Math.floor((sec%3600)/60), S=sec%60;
                      setH(H); setM(M); setS(S); setRemaining(sec); setInitialDuration(0);
                    }} disabled={running} />
                    <ProgressBar progress={timerProgress} warn={!!lastSeconds} />
                  </div>
                ) : null}
              </div>

              {/* ✅ Aide : cachée en mode élève */}
              {!studentView && <HelpSection />}

              {/* Petit rappel discret du raccourci (optionnel) */}
              {!studentView ? null : (
                <div className="mt-4 text-xs text-zinc-500 text-right">
                  Raccourci : touche <span className="px-2 py-1 rounded bg-white/10 border border-white/10">E</span>
                </div>
              )}
            </div>
          </div>
        );
      }

      function StudentViewToggle({ value, onChange }) {
        return (
          <button
            onClick={() => onChange(!value)}
            className={`px-3 py-2 text-sm rounded-xl border border-white/10 transition
              ${value ? "bg-white/15" : "bg-white/5 hover:bg-white/10"}`}
            aria-pressed={value}
            title="Basculer l'affichage élève (touche E)"
          >
            Affichage élève {value ? "✓" : ""}
          </button>
        );
      }

      function TimeDisplay({ value, format, running, studentView }) {
        return (
          <div>
            <div className={`${studentView ? "text-[72px] md:text-[96px]" : "text-[56px] md:text-[72px]"} font-bold tabular-nums leading-none select-none drop-shadow-[0_0_12px_rgba(250,204,21,0.15)]`}>
              {format(value)}
            </div>
            {!studentView && (
              <div className="mt-2 text-sm text-zinc-400">
                {running ? "En cours…" : "En pause"}
              </div>
            )}
          </div>
        );
      }

      function TimerInputs({ h, m, s, onH, onM, onS, disabled }) {
        const clamp = (v,max)=> Math.min(Math.max(0, v), max);
        const parse = (v)=> Number.isNaN(parseInt(v)) ? 0 : parseInt(v);
        return (
          <div className="flex flex-col items-start gap-2">
            <label className="text-sm text-zinc-400">Durée du minuteur</label>
            <div className="flex items-center gap-3 flex-wrap">
              <NumberInput label="heures" value={h} onChange={(v)=>onH(clamp(parse(v), 99))} disabled={disabled} />
              <span className="opacity-50">:</span>
              <NumberInput label="minutes" value={m} onChange={(v)=>onM(clamp(parse(v), 59))} disabled={disabled} />
              <span className="opacity-50">:</span>
              <NumberInput label="secondes" value={s} onChange={(v)=>onS(clamp(parse(v), 59))} disabled={disabled} />
            </div>
          </div>
        );
      }

      function NumberInput({ label, value, onChange, disabled }) {
        return (
          <div className="flex flex-col items-start">
            <input
              type="number"
              min={0}
              max={label === "heures" ? 99 : 59}
              value={value}
              onChange={(e)=>onChange(e.target.value)}
              disabled={disabled}
              className="w-24 px-3 py-2 rounded-xl bg-zinc-900/70 border border-white/10 focus:outline-none focus:ring-2 focus:ring-amber-400 tabular-nums"
              aria-label={label}
            />
            <span className="mt-1 text-xs text-zinc-500">{label}</span>
          </div>
        );
      }

      function ModeSwitcher({ mode, onChange }) {
        return (
          <div className="bg-white/5 border border-white/10 rounded-xl p-1 flex gap-1">
            <button
              onClick={()=>onChange("chronometre")}
              className={`px-3 py-2 text-sm rounded-lg transition ${mode === "chronometre" ? "bg-amber-500 text-zinc-900" : "hover:bg-white/10"}`}
              aria-pressed={mode === "chronometre"}
            >Chronomètre</button>
            <button
              onClick={()=>onChange("minuteur")}
              className={`px-3 py-2 text-sm rounded-lg transition ${mode === "minuteur" ? "bg-amber-500 text-zinc-900" : "hover:bg-white/10"}`}
              aria-pressed={mode === "minuteur"}
            >Minuteur</button>
          </div>
        );
      }

      function PresetRow({ onPick, disabled }){
        const Btn = ({ label, sec }) => (
          <button onClick={()=>onPick(sec)} disabled={disabled}
            className="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/15 disabled:opacity-50 transition text-sm">{label}</button>
        );
        return (
          <div className="mt-4 flex items-center gap-2 flex-wrap text-sm text-zinc-400">
            <span>Presets:</span>
            <Btn label="30 s"  sec={30} />
            <Btn label="5 min" sec={300} />
            <Btn label="10 min" sec={600} />
            <Btn label="15 min" sec={900} />
          </div>
        );
      }

      function HelpSection(){
        return (
          <div className="mt-6 text-sm text-zinc-400 space-y-1">
            <p>• Chronomètre: Démarrer, Arrêter, Remettre à zéro.</p>
            <p>• Minuteur: règle heures/minutes/secondes, Démarrer. Alarme à la fin.</p>
            <p>• Presets: 30 s, 5/10/15 min. Les 10 dernières secondes pulsent en doré.</p>
          </div>
        );
      }

      function TimeTurnerVisual({ running }) {
        return (
          <div className="relative w-[220px] h-[220px] mx-auto select-none">
            <div className={`absolute inset-0 rounded-full bg-gradient-to-tr from-amber-300/10 to-amber-500/10 ${running ? "animate-aura" : ""}`}></div>
            <svg viewBox="0 0 200 200" className="w-full h-full">
              <g className={running ? "animate-spin-slow origin-center" : "origin-center"}>
                <circle cx="100" cy="100" r="92" fill="none" stroke="rgba(250,204,21,0.55)" strokeWidth="3" />
                <circle cx="100" cy="100" r="86" fill="none" stroke="rgba(250,204,21,0.25)" strokeWidth="2" strokeDasharray="6 10" />
              </g>
              <g className={running ? "animate-spin-rev origin-center" : "origin-center"}>
                <circle cx="100" cy="100" r="62" fill="none" stroke="rgba(250,204,21,0.6)" strokeWidth="3" />
                <circle cx="100" cy="100" r="56" fill="none" stroke="rgba(250,204,21,0.25)" strokeWidth="2" strokeDasharray="4 8" />
              </g>
              <g>
                <rect x="92" y="65" width="16" height="70" rx="8" fill="rgba(255,255,255,0.06)" stroke="rgba(250,204,21,0.8)" />
                <path d="M92 80 L108 95 L92 110 Z" fill="rgba(250,204,21,0.7)" />
                <path d="M108 95 L92 110 L108 125 Z" fill="rgba(250,204,21,0.35)" />
              </g>
            </svg>
          </div>
        );
      }

      function HourglassVisual({ running, progress, warn }) {
        const pct = Math.min(1, Math.max(0, progress));
        const topSand = 1 - pct;
        const bottomSand = pct;
        return (
          <div className="relative w-[220px] h-[260px] mx-auto select-none">
            <div className={`absolute -inset-2 rounded-2xl ${warn ? "animate-warning" : running ? "animate-aura" : ""}`}></div>
            <svg viewBox="0 0 200 240" className="w-full h-full drop-shadow-[0_0_10px_rgba(250,204,21,0.15)]">
              <path d="M40 20 H160 C150 60 120 90 100 110 C80 90 50 60 40 20 Z" fill="rgba(255,255,255,0.04)" stroke="rgba(255,255,255,0.25)"/>
              <path d="M40 220 H160 C150 180 120 150 100 130 C80 150 50 180 40 220 Z" fill="rgba(255,255,255,0.04)" stroke="rgba(255,255,255,0.25)"/>
              <clipPath id="topClip"><path d="M40 20 H160 C150 60 120 90 100 110 C80 90 50 60 40 20 Z" /></clipPath>
              <rect x="42" y={22 + 84 * topSand} width="116" height={84 * (1 - topSand) + 4} fill="rgba(250,204,21,0.65)" clipPath="url(#topClip)" />
              {running && pct < 1 && (
                <rect x="98" y="108" width="4" height="24" fill="rgba(250,204,21,0.85)" className="animate-sand" />
              )}
              <clipPath id="botClip"><path d="M40 220 H160 C150 180 120 150 100 130 C80 150 50 180 40 220 Z" /></clipPath>
              <rect x="42" y={220 - 84 * bottomSand - 4} width="116" height={84 * bottomSand + 4} fill="rgba(250,204,21,0.55)" clipPath="url(#botClip)" />
              <rect x="35" y="12" width="130" height="8" rx="4" fill="rgba(250,204,21,0.75)" />
              <rect x="35" y="220" width="130" height="8" rx="4" fill="rgba(250,204,21,0.75)" />
              <rect x="35" y="28" width="8" height="196" rx="4" fill="rgba(250,204,21,0.35)" />
              <rect x="157" y="28" width="8" height="196" rx="4" fill="rgba(250,204,21,0.35)" />
            </svg>
          </div>
        );
      }

      function ProgressBar({ progress, warn }) {
        return (
          <div className="mt-4 h-2 w-full bg-white/10 rounded-full overflow-hidden">
            <div className={`h-full ${warn ? "bg-amber-400 animate-pulse" : "bg-amber-300"}`} style={{ width: `${Math.round(progress * 100)}%` }} />
          </div>
        );
      }

      // Monter l'app
      const root = ReactDOM.createRoot(document.getElementById("app"));
      root.render(<MinuteurChronometre />);
    </script>
  </body>
</html>
